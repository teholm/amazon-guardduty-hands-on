


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="This hands-on workshop is where you will learn about a number of AWS services involved with threat detection and response as we walk through real-world threat scenarios. Learn about the threat detection capabilities of Amazon GuardDuty, Amazon Macie and AWS Security Hub and the available response options. For each hands-on scenario, we review methods to detect and respond to threats using the following services: AWS CloudTrail, Amazon VPC flow logs, Amazon CloudWatch Events, Amazon Macie, AWS Lambda, Amazon Inspector, Amazon GuardDuty and Amazon Security Hub.">
      
      
        <link rel="canonical" href="https://hands-on-guardduty.awssecworkshops.com/scenario3/">
      
      
        <meta name="author" content="aws-security-workshops@amazon.com">
      
      <link rel="shortcut icon" href="../assets/images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.6">
    
    
      
        <title>IAM Role Credential Exfiltration - Getting Hands on with Amazon GuardDuty</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.63b94e9e.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#iam-role-credential-exfiltration" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://hands-on-guardduty.awssecworkshops.com/" title="Getting Hands on with Amazon GuardDuty" class="md-header-nav__button md-logo" aria-label="Getting Hands on with Amazon GuardDuty">
      
  <img src="../assets/images/aws_smile_logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Getting Hands on with Amazon GuardDuty
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              IAM Role Credential Exfiltration
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/aws-samples/amazon-guardduty-hands-on/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/amazon-guardduty-hands-on
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://hands-on-guardduty.awssecworkshops.com/" title="Getting Hands on with Amazon GuardDuty" class="md-nav__button md-logo" aria-label="Getting Hands on with Amazon GuardDuty">
      
  <img src="../assets/images/aws_smile_logo.png" alt="logo">

    </a>
    Getting Hands on with Amazon GuardDuty
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/aws-samples/amazon-guardduty-hands-on/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/amazon-guardduty-hands-on
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../setup/" title="Environment Setup" class="md-nav__link">
      Environment Setup
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../scenario1/" title="Compromised EC2 Instance" class="md-nav__link">
      Compromised EC2 Instance
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../scenario2/" title="Compromised IAM Credentials" class="md-nav__link">
      Compromised IAM Credentials
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        IAM Role Credential Exfiltration
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="IAM Role Credential Exfiltration" class="md-nav__link md-nav__link--active">
      IAM Role Credential Exfiltration
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#generate-a-finding-manually" class="md-nav__link">
    Generate a finding manually
  </a>
  
    <nav class="md-nav" aria-label="Generate a finding manually">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#retrieve-the-iam-temporary-security-credentials-using-aws-systems-manager" class="md-nav__link">
    Retrieve the IAM temporary security credentials using AWS Systems Manager
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-new-aws-cli-profile-on-your-laptop-to-use-the-iam-temporary-credentials" class="md-nav__link">
    Create a new AWS CLI profile on your laptop to use the IAM temporary credentials
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-commands-using-the-iam-temporary-credentials" class="md-nav__link">
    Run commands using the IAM temporary credentials
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture-overview" class="md-nav__link">
    Architecture Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#investigation" class="md-nav__link">
    Investigation
  </a>
  
    <nav class="md-nav" aria-label="Investigation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#browse-to-the-guardduty-console-to-investigate" class="md-nav__link">
    Browse to the GuardDuty console to investigate
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-the-cloudwatch-event-rule" class="md-nav__link">
    View the CloudWatch Event rule
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-the-remediation-lambda-function" class="md-nav__link">
    View the remediation Lambda function
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify-that-the-remediation-was-successful" class="md-nav__link">
    Verify that the remediation was successful
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#questions" class="md-nav__link">
    Questions
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../summary/" title="Summary" class="md-nav__link">
      Summary
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../contribute/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#generate-a-finding-manually" class="md-nav__link">
    Generate a finding manually
  </a>
  
    <nav class="md-nav" aria-label="Generate a finding manually">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#retrieve-the-iam-temporary-security-credentials-using-aws-systems-manager" class="md-nav__link">
    Retrieve the IAM temporary security credentials using AWS Systems Manager
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-new-aws-cli-profile-on-your-laptop-to-use-the-iam-temporary-credentials" class="md-nav__link">
    Create a new AWS CLI profile on your laptop to use the IAM temporary credentials
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-commands-using-the-iam-temporary-credentials" class="md-nav__link">
    Run commands using the IAM temporary credentials
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture-overview" class="md-nav__link">
    Architecture Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#investigation" class="md-nav__link">
    Investigation
  </a>
  
    <nav class="md-nav" aria-label="Investigation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#browse-to-the-guardduty-console-to-investigate" class="md-nav__link">
    Browse to the GuardDuty console to investigate
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-the-cloudwatch-event-rule" class="md-nav__link">
    View the CloudWatch Event rule
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-the-remediation-lambda-function" class="md-nav__link">
    View the remediation Lambda function
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify-that-the-remediation-was-successful" class="md-nav__link">
    Verify that the remediation was successful
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#questions" class="md-nav__link">
    Questions
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/amazon-guardduty-hands-on/edit/master/docs/scenario3/index.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="iam-role-credential-exfiltration">IAM Role credential exfiltration</h1>
<h3 id="generate-a-finding-manually">Generate a finding manually</h3>
<p>All of the simulated attacks and findings are generated automatically in the CloudFormation template except for one; which requires you to take some manual steps.  To produce the final finding, you will need to copy the IAM temporary security credentials from the EC2 instance and manually make API calls from your laptop.</p>
<div class="admonition info">
<p class="admonition-title">API calls need to come from outside the AWS network or they will not generate findings</p>
</div>
<h4 id="retrieve-the-iam-temporary-security-credentials-using-aws-systems-manager">Retrieve the IAM temporary security credentials using AWS Systems Manager</h4>
<p>To simulate this last and final attack you will need to retrieve the IAM temporary security credentials generated by the IAM Role for EC2. You can either SSH directly to the instance and query the metadata or follow the steps below to use <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager.html" target="_blank">AWS Systems Manager Session Manager</a> (an SSM agent was automatically started on the instance at launch).</p>
<ol>
<li>
<p>Go to <a href="https://us-west-2.console.aws.amazon.com/systems-manager/managed-instances?region=us-west-2" target="_blank">Managed Instances</a> within the <strong>AWS Systems Manager</strong> console (us-west-2).</p>
<blockquote>
<p>You should see an instance named <strong>GuardDuty-Example: Compromised Instance: Scenario 3</strong> with a ping status of <strong>Online</strong>.</p>
</blockquote>
</li>
<li>
<p>To see the keys currently active on the instance, click on <strong>Session Manager</strong> on the left navigation and then click <strong>Start Session</strong>.</p>
</li>
<li>To see the credentials currently active on the instance, click on the radio button next to <strong>Compromised Instance: Scenario 3</strong> and click <strong>Start Session</strong>.</li>
<li>Run the following command in the shell:</li>
</ol>
<div class="codehilite"><pre><span></span><code>curl http://169.254.169.254/latest/meta-data/iam/security-credentials/GuardDuty-Example-EC2-Compromised
</code></pre></div>


<ol>
<li>Make note of the <strong>AccessKeyID</strong>, <strong>SecretAccessKey</strong>, and <strong>Token</strong>.</li>
</ol>
<h4 id="create-a-new-aws-cli-profile-on-your-laptop-to-use-the-iam-temporary-credentials">Create a new AWS CLI profile on your laptop to use the IAM temporary credentials</h4>
<p>Now that you have retrieved the IAM temporary security credentials you will need to add them to an AWS CLI profile. There are a number of ways to do this, but below are some commands to help get you started:</p>
<p>From a command prompt, run the following commands (replace the variables with your credentials):</p>
<div class="codehilite"><pre><span></span><code><span class="err">aws configure set profile.badbob.region us-west-2</span>
<span class="err">aws configure set profile.badbob.aws_access_key_id &lt;access_key&gt;</span>
<span class="err">aws configure set profile.badbob.aws_secret_access_key &lt;secret_key&gt;</span>
<span class="err">aws configure set profile.badbob.aws_session_token &lt;session_token&gt;</span>
</code></pre></div>


<p>If you view your local aws credentials file, you should now see an [badbob] profile with the stolen IAM temporary credentials.</p>
<h4 id="run-commands-using-the-iam-temporary-credentials">Run commands using the IAM temporary credentials</h4>
<p>Now that you have your named profile you can use it to make API calls. Use the commands below to query different services to see what you have access to.</p>
<div class="admonition failure">
<p class="admonition-title">Don't be surprised if you see some access denied responses, it is intended</p>
</div>
<p><strong>Do you have any IAM permissions:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">aws</span> <span class="n">iam</span> <span class="k">get</span><span class="o">-</span><span class="k">user</span> <span class="c1">--profile badbob</span>

<span class="n">aws</span> <span class="n">iam</span> <span class="k">create</span><span class="o">-</span><span class="k">user</span> <span class="c1">--user-name Chuck --profile badbob</span>
</code></pre></div>


<p><strong>What about DynamoDB?</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">aws</span> <span class="n">dynamodb</span> <span class="n">list</span><span class="o">-</span><span class="n">tables</span> <span class="c1">--profile badbob</span>

<span class="n">aws</span> <span class="n">dynamodb</span> <span class="k">describe</span><span class="o">-</span><span class="k">table</span> <span class="c1">--table-name GuardDuty-Example-Customer-DB --profile badbob</span>
</code></pre></div>


<p><strong>Can you query the data?</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">aws</span> <span class="n">dynamodb</span> <span class="n">scan</span> <span class="c1">--table-name GuardDuty-Example-Customer-DB --profile badbob</span>

<span class="n">aws</span> <span class="n">dynamodb</span> <span class="n">put</span><span class="o">-</span><span class="n">item</span> <span class="c1">--table-name GuardDuty-Example-Customer-DB --item &#39;{&quot;name&quot;:{&quot;S&quot;:&quot;Joshua Tree&quot;},&quot;state&quot;:{&quot;S&quot;:&quot;Michigan&quot;},&quot;website&quot;:{&quot;S&quot;:&quot;https://www.nps.gov/yell/index.htm&quot;}}&#39; --profile badbob</span>

<span class="n">aws</span> <span class="n">dynamodb</span> <span class="n">scan</span> <span class="c1">--table-name GuardDuty-Example-Customer-DB --profile badbob</span>

<span class="n">aws</span> <span class="n">dynamodb</span> <span class="k">delete</span><span class="o">-</span><span class="k">table</span> <span class="c1">--table-name GuardDuty-Example-Customer-DB --profile badbob</span>

<span class="n">aws</span> <span class="n">dynamodb</span> <span class="n">list</span><span class="o">-</span><span class="n">tables</span> <span class="c1">--profile badbob</span>
</code></pre></div>


<p><strong>Do you have access to Systems Manager Parameter Store?</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">aws</span> <span class="n">ssm</span> <span class="k">describe</span><span class="o">-</span><span class="k">parameters</span> <span class="c1">--profile badbob</span>

<span class="n">aws</span> <span class="n">ssm</span> <span class="k">get</span><span class="o">-</span><span class="k">parameters</span> <span class="c1">--names &quot;gd_prod_dbpwd_sample&quot; --profile badbob</span>

<span class="n">aws</span> <span class="n">ssm</span> <span class="k">get</span><span class="o">-</span><span class="k">parameters</span> <span class="c1">--names &quot;gd_prod_dbpwd_sample&quot; --with-decryption --profile badbob</span>

<span class="n">aws</span> <span class="n">ssm</span> <span class="k">delete</span><span class="o">-</span><span class="k">parameter</span> <span class="c1">--name &quot;gd_prod_dbpwd_sample&quot; --profile badbob</span>
</code></pre></div>


<p>After manually remediating the previous GuardDuty finding, you have finally finished your first cup of coffee when an email notification comes in alerting you to yet another finding.  You finish reading the first email and then a minute or so later you see the relevant remediation email, meaning Alice has already put in place a remediation for this finding.  The other findings you looked at dealt with EC2 instances and AWS IAM credentials separately, but this finding appears to be related to an AWS IAM Role associated with an EC2 instance.  You decide to take a closer look at the finding and remediation.</p>
<div class="admonition attention">
<p class="admonition-title">None of your personal IAM credentials have actually been compromised or exposed in any way.</p>
</div>
<h2 id="architecture-overview">Architecture Overview</h2>
<p><img alt="Attack Scenario 3" src="images/attack3.png" title="Attack Scenario 3" /></p>
<blockquote>
<ol>
<li>The remote host accesses the <strong>compromised instance</strong> and exfiltrates the IAM role credentials via the metadata.</li>
<li>The remote host sets up a CLI user to make API calls to the AWS account to which the credentials belong.</li>
<li>GuardDuty generates a finding and sends this to the GuardDuty console and CloudWatch Events.</li>
<li>The CloudWatch Event rule triggers an SNS topic and a Lambda function.</li>
<li>SNS sends you an e-mail with the finding information.</li>
<li>A Lambda function attaches a policy to the role revoking all active sessions.</li>
</ol>
</blockquote>
<h2 id="investigation">Investigation</h2>
<h3 id="browse-to-the-guardduty-console-to-investigate">Browse to the GuardDuty console to investigate</h3>
<p>To view the findings:</p>
<ol>
<li>Navigate to the <a href="https://us-west-2.console.aws.amazon.com/guardduty/home?" target="_blank">GuardDuty console</a> (us-west-2) and then, in the navigation pane on the left, choose <strong>Current</strong>.</li>
<li>
<p>Click the  <img alt="Refresh" src="images/refreshicon.png" title="Refresh" /> icon to refresh the GuardDuty console. You should see a finding with the type <strong>UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration</strong>.</p>
</li>
<li>
<p>Click on the <strong>UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration</strong> finding to view the full details.</p>
</li>
</ol>
<p>Looking at the finding details you can see that this is actually a <strong>High Severity</strong> finding.  This finding informs you of attempts to run AWS API operations from a host outside of EC2, using temporary AWS credentials that were created on an EC2 instance in your AWS account.  This means your EC2 instance has been compromised, and the temporary credentials from the instance have been exfiltrated to a remote host outside of AWS.</p>
<blockquote>
<p>You will notice that each GuardDuty finding has an assigned severity level (low, medium, or high) that can help you determine your response to a potential security issue that is highlighted by the finding.  These severity levels are preset by AWS but we have seen customers modify these values in their automation workflows to better align the risk of that finding in the context of their environment and requirements.</p>
</blockquote>
<h3 id="view-the-cloudwatch-event-rule">View the CloudWatch Event rule</h3>
<ol>
<li>Navigate to the <a href="https://us-west-2.console.aws.amazon.com/cloudwatch/home?" target="_blank">CloudWatch console</a> (us-west-2) and on the left navigation, under the <strong>Events</strong> section, click <strong>Rules</strong>.</li>
<li>Click on the rule that Alice configured for this particular finding (<strong>GuardDuty-Event-IAMUser-InstanceCredentialExfiltration</strong>).</li>
</ol>
<p>Take a closer look at the <strong>Event Pattern</strong>.  The pattern Alice setup for all the rules specifies particular findings.  </p>
<blockquote>
<p>Like Alice, you can create CloudWatch Event Rules that are triggered for particular findings but you can also create a rule that is triggered based on any GuardDuty finding in order to have a centralized workflow.  Below is an example of an Event Pattern that would trigger for any GuardDuty finding:</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="err">{</span>
<span class="err">  &quot;detail-type&quot;: [</span>
<span class="err">    &quot;GuardDuty Finding&quot;</span>
<span class="err">  ],</span>
<span class="err">  &quot;source&quot;: [</span>
<span class="err">    &quot;aws.guardduty&quot;</span>
<span class="err">  ]</span>
<span class="err">}</span>
</code></pre></div>


<h3 id="view-the-remediation-lambda-function">View the remediation Lambda function</h3>
<p>Alice also set up a remediation for this threat. Look through the Lambda Function code to better understand the remediation.</p>
<p>Go to the <a href="https://us-west-2.console.aws.amazon.com/lambda/home?" target="_blank">Lambda console</a> (us-west-2) and review the function named <strong>GuardDuty-Example-Remediation-InstanceCredentialExfiltration</strong>.</p>
<p>The Lambda Function retrieves the Role name from the finding details and then attaches an IAM policy that revokes all active sessions for the role.</p>
<blockquote>
<p>What permissions does the Lambda Function need to perform the remediation?  Is there a risk associated with this level of permissions?</p>
</blockquote>
<h3 id="verify-that-the-remediation-was-successful">Verify that the remediation was successful</h3>
<p>To verify that the <strong>InstanceCredentialExfiltration</strong> finding was remediated, you can run one of the CLI commands you ran earlier.</p>
<div class="codehilite"><pre><span></span><code><span class="err">aws dynamodb list-tables --profile attacker</span>
</code></pre></div>


<p>You should see a response that states that there is an explicit deny for that action. Go view the Role to evaluate the policy that was attached.</p>
<ol>
<li>Browse to the <a href="https://console.aws.amazon.com/iam/home?region=us-west-2" target="_blank">AWS IAM</a> console.</li>
<li>Click <strong>Roles</strong> in the left navigation.</li>
<li>Click on the Role you identified in the GuardDuty finding and email notifications (<strong>GuardDuty-Example-EC2-Compromised</strong>).</li>
<li>Click the <strong>Permissions</strong> tab.</li>
<li>Click on the <strong>RevokeOldSessions</strong> Policy.</li>
</ol>
<h2 id="questions">Questions</h2>
<div class="admonition question">
<p class="admonition-title">What are the risks involved with this remediation?</p>
</div>
<div class="admonition question">
<p class="admonition-title">What other EC2 instances are using this Role?</p>
</div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../scenario2/" title="Compromised IAM Credentials" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Compromised IAM Credentials
              </div>
            </div>
          </a>
        
        
          <a href="../summary/" title="Summary" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Summary
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            <a href="https://aws.amazon.com/privacy/" target="_blank">Privacy</a> | <a href="https://aws.amazon.com/terms/" target="_blank">Site terms</a> | &copy; 2020, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://awssecworkshops.com" target="_blank" rel="noopener" title="awssecworkshops.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M280.37 148.26L96 300.11V464a16 16 0 0016 16l112.06-.29a16 16 0 0015.92-16V368a16 16 0 0116-16h64a16 16 0 0116 16v95.64a16 16 0 0016 16.05L464 480a16 16 0 0016-16V300L295.67 148.26a12.19 12.19 0 00-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 00-12-12h-56a12 12 0 00-12 12v72.61L318.47 43a48 48 0 00-61 0L4.34 251.47a12 12 0 00-1.6 16.9l25.5 31A12 12 0 0045.15 301l235.22-193.74a12.19 12.19 0 0115.3 0L530.9 301a12 12 0 0016.9-1.6l25.5-31a12 12 0 00-1.7-16.93z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://aws.amazon.com/security/" target="_blank" rel="noopener" title="aws.amazon.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M466.5 83.7l-192-80a48.15 48.15 0 00-36.9 0l-192 80C27.7 91.1 16 108.6 16 128c0 198.5 114.5 335.7 221.5 380.3 11.8 4.9 25.1 4.9 36.9 0C360.1 472.6 496 349.3 496 128c0-19.4-11.7-36.9-29.5-44.3zM256.1 446.3l-.1-381 175.9 73.3c-3.3 151.4-82.1 261.1-175.8 307.7z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/awssecurityinfo?lang=en" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://aws.amazon.com/blogs/security/" target="_blank" rel="noopener" title="aws.amazon.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M400 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zM112 416c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm157.533 0h-34.335c-6.011 0-11.051-4.636-11.442-10.634-5.214-80.05-69.243-143.92-149.123-149.123-5.997-.39-10.633-5.431-10.633-11.441v-34.335c0-6.535 5.468-11.777 11.994-11.425 110.546 5.974 198.997 94.536 204.964 204.964.352 6.526-4.89 11.994-11.425 11.994zm103.027 0h-34.334c-6.161 0-11.175-4.882-11.427-11.038-5.598-136.535-115.204-246.161-251.76-251.76C68.882 152.949 64 147.935 64 141.774V107.44c0-6.454 5.338-11.664 11.787-11.432 167.83 6.025 302.21 141.191 308.205 308.205.232 6.449-4.978 11.787-11.432 11.787z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.d1f5a259.min.js"></script>
      <script src="../assets/javascripts/bundle.d5fec882.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.fae956e7.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>